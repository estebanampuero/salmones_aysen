<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema creación de documentos Salmones Aysen</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-b from-gray-50 to-gray-200 p-6">
  <div class="w-full max-w-4xl mx-auto p-8 rounded-3xl shadow-2xl bg-white">
    <div class="mb-8">
      <h2 class="text-3xl font-bold text-gray-800 text-center mb-2">Sistema creación de documentos Salmones Aysen</h2>
      <p class="text-center text-gray-600">Oficina Calidad - Salmones Aysén</p>
    </div>

    <form id="procedimientoForm" class="space-y-6">
      
      <!-- Titulo -->
      <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
        <label class="text-gray-700 font-semibold text-sm">TÍTULO DEL DOCUMENTO</label>
        <div class="flex flex-col gap-4 mt-2">
            <div>
                <input id="titulo1" name="titulo1" type="text" required
                  placeholder="Ingrese la primera parte del título..."
                  class="border border-gray-300 rounded-xl p-3 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
                <input id="titulo2" name="titulo2" type="text"
                  placeholder="Ingrese la segunda parte del título (opcional)..."
                  class="border border-gray-300 rounded-xl p-3 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
        </div>
      </div>
      
      <!-- Información del documento -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded-xl">
        <div>
          <label for="codigo" class="text-gray-700 font-semibold text-sm">Código</label>
          <input id="codigo" name="codigo" type="text" required
            placeholder="Ej: PRO-GD-001"
            class="border border-gray-300 rounded-xl p-3 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        
        <div>
          <label for="fecha_creacion" class="text-gray-700 font-semibold text-sm">Fecha de Creación</label>
          <input id="fecha_creacion" name="fecha_creacion" type="date" required
            class="border border-gray-300 rounded-xl p-3 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>

        <div>
          <label for="version" class="text-gray-700 font-semibold text-sm">Versión</label>
          <input id="version" name="version" type="text" required
            placeholder="Ej: 2.0"
            class="border border-gray-300 rounded-xl p-3 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        
        <div>
            <label for="fecha_modificacion" class="text-gray-700 font-semibold text-sm">Fecha de Modificación</label>
            <input id="fecha_modificacion" name="fecha_modificacion" type="date" 
              class="border border-gray-300 rounded-xl p-3 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
      </div>


      <!-- 1. OBJETIVO -->
      <div>
        <label for="objetivo" class="text-gray-700 font-semibold text-sm">1. OBJETIVO</label>
        <textarea id="objetivo" name="objetivo" rows="4" required
          placeholder="Ingrese el objetivo del procedimiento..."
          class="border border-gray-300 rounded-xl p-3 w-full focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
      </div>

      <!-- 2. ALCANCE -->
      <div>
        <label for="alcance" class="text-gray-700 font-semibold text-sm">2. ALCANCE</label>
        <textarea id="alcance" name="alcance" rows="3" required
          placeholder="Ingrese el alcance del procedimiento..."
          class="border border-gray-300 rounded-xl p-3 w-full focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
      </div>

      <!-- 3. MARCO TEÓRICO -->
      <div>
        <label class="text-gray-700 font-semibold text-sm">3. MARCO TEÓRICO</label>
        <div id="marcoTeoricoContainer" class="space-y-2">
          <div class="marco-teorico-item flex gap-2">
            <input type="text" class="marco-teorico-input flex-1 border rounded-xl p-3" 
              placeholder="Ingrese texto del marco teórico...">
            <button type="button" class="remove-btn text-red-500 px-2" style="display:none">✕</button>
          </div>
        </div>
        <button type="button" id="addMarcoTeorico" class="mt-2 bg-gray-100 rounded-xl px-4 py-2 text-sm">
          + Agregar Texto
        </button>
      </div>

      <!-- 4. DEFINICIONES -->
      <div>
        <label class="text-gray-700 font-semibold text-sm">4. DEFINICIONES</label>
        <div id="definicionesContainer" class="space-y-2">
          <div class="definicion-item flex gap-2">
            <input type="text" class="def-termino border rounded-xl p-3 w-1/3" 
              placeholder="Término">
            <input type="text" class="def-descripcion border rounded-xl p-3 flex-1" 
              placeholder="Descripción">
            <button type="button" class="remove-def text-red-500 px-2" style="display:none">✕</button>
          </div>
        </div>
        <button type="button" id="addDefinicion" class="mt-2 bg-gray-100 rounded-xl px-4 py-2 text-sm">
          + Agregar Definición
        </button>
      </div>

      <!-- 5. RESPONSABILIDADES (Jerárquico) -->
      <div>
        <label class="text-gray-700 font-semibold text-sm">5. RESPONSABILIDADES</label>
        <div id="responsabilidadesContainer" class="space-y-4">
            <!-- Contenido dinámico -->
        </div>
        <button type="button" id="addResponsabilidadPrincipal" class="mt-2 bg-blue-100 text-blue-700 rounded-xl px-4 py-2 text-sm">
            + Agregar Responsabilidad Principal
        </button>
      </div>

      <!-- 6. MATERIALES -->
      <div>
        <label class="text-gray-700 font-semibold text-sm">6. MATERIALES</label>
        <div id="materialesContainer" class="space-y-2">
          <div class="material-item flex gap-2">
            <input type="text" class="material-input flex-1 border rounded-xl p-3" 
              placeholder="Ingrese material...">
            <button type="button" class="remove-mat text-red-500 px-2" style="display:none">✕</button>
          </div>
        </div>
        <button type="button" id="addMaterial" class="mt-2 bg-gray-100 rounded-xl px-4 py-2 text-sm">
          + Agregar Material
        </button>
      </div>

      <!-- 7. DESCRIPCIÓN DE LA ACTIVIDAD (Jerárquico) -->
      <div>
        <div class="flex items-center gap-2 mb-2">
          <label class="text-gray-700 font-semibold text-sm">7. DESCRIPCIÓN DE LA ACTIVIDAD</label>
          <span id="sangriaHelpIcon" class="cursor-pointer bg-blue-100 text-blue-700 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold hover:bg-blue-200 transition-colors">?</span>
        </div>
        <div id="actividadContainer" class="space-y-2"> <!-- Se reduce el space-y para mejor visual -->
            <!-- Contenido dinámico -->
        </div>
        <button type="button" id="addTitulo" class="mt-3 bg-blue-100 text-blue-700 rounded-xl px-4 py-2 text-sm">
          + Agregar Elemento
        </button>
      </div>

      <!-- 8. REGISTROS -->
      <div>
        <label class="text-gray-700 font-semibold text-sm">8. REGISTROS</label>
        <div id="registrosContainer" class="space-y-2">
          <div class="registro-item flex gap-2">
            <input type="text" class="registro-input flex-1 border rounded-xl p-3" 
              placeholder="Ingrese registro...">
            <button type="button" class="remove-reg text-red-500 px-2" style="display:none">✕</button>
          </div>
        </div>
        <button type="button" id="addRegistro" class="mt-2 bg-gray-100 rounded-xl px-4 py-2 text-sm">
          + Agregar Registro
        </button>
      </div>

      <!-- 9. CONTROL DE CAMBIO -->
      <div>
        <label class="text-gray-700 font-semibold text-sm">9. CONTROL DE CAMBIO</label>
        <div class="overflow-x-auto">
          <table class="w-full border-collapse border border-gray-300 mt-2">
            <thead>
              <tr class="bg-gray-100">
                <th class="border border-gray-300 py-1 px-2 text-sm">Versión N°</th>
                <th class="border border-gray-300 py-1 px-2 text-sm">Fecha modificación</th>
                <th class="border border-gray-300 py-1 px-2 text-sm">Descripción del Cambio</th>
                <th class="border border-gray-300 py-1 px-2 text-sm w-16"></th>
              </tr>
            </thead>
            <tbody id="cambiosTableBody">
              <tr class="cambio-row">
                <td class="border border-gray-300 py-1 px-2 align-middle">
                  <input type="text" class="cambio-version w-full border-0 p-1" placeholder="1.0">
                </td>
                <td class="border border-gray-300 py-1 px-2 align-middle">
                  <input type="date" class="cambio-fecha w-full border-0 p-1">
                </td>
                <td class="border border-gray-300 py-1 px-2 align-middle">
                  <input type="text" class="cambio-descripcion w-full border-0 p-1" placeholder="Descripción del cambio">
                </td>
                <td class="border border-gray-300 py-1 px-2 text-center align-middle">
                  <button type="button" class="remove-cambio text-red-500" style="display:none">✕</button>
                </td>
              </tr>
            </tbody>
          </table>
          <button type="button" id="addCambio" class="mt-2 bg-gray-100 rounded-xl px-4 py-2 text-sm">
            + Agregar Cambio
          </button>
        </div>
      </div>

      <!-- Firmas -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-t pt-6">
        <div class="text-center">
          <label class="text-gray-700 font-semibold text-sm block mb-2">Elaboró</label>
          <input name="elaboro" type="text" required
            placeholder="Nombre y apellido"
            class="border border-gray-300 rounded-xl p-2 w-full mb-2 text-center" />
          <input name="cargo_elaboro" type="text" required
            placeholder="Cargo"
            class="border border-gray-300 rounded-xl p-2 w-full text-center" />
        </div>

        <div class="text-center">
          <label class="text-gray-700 font-semibold text-sm block mb-2">Revisó</label>
          <input name="reviso" type="text" required
            placeholder="Nombre y apellido"
            class="border border-gray-300 rounded-xl p-2 w-full mb-2 text-center" />
          <input name="cargo_reviso" type="text" required
            placeholder="Cargo"
            class="border border-gray-300 rounded-xl p-2 w-full text-center" />
        </div>

        <div class="text-center">
          <label class="text-gray-700 font-semibold text-sm block mb-2">Aprobó</label>
          <input name="aprobo" type="text" required
            placeholder="Nombre y apellido"
            class="border border-gray-300 rounded-xl p-2 w-full mb-2 text-center" />
          <input name="cargo_aprobo" type="text" required
            placeholder="Cargo"
            class="border border-gray-300 rounded-xl p-2 w-full text-center" />
        </div>
      </div>

      <button type="submit" 
        class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold py-3 rounded-2xl hover:scale-105 transition-transform duration-300">
        Enviar
      </button>
    </form>
    
  </div>

  <!-- MODAL DE AYUDA -->
  <div id="sangriaHelpModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden transition-opacity duration-300 opacity-0">
    <div class="bg-white rounded-2xl shadow-xl p-6 max-w-sm mx-auto transform transition-all duration-300 scale-95">
        <h3 class="text-lg font-bold text-gray-800 mb-3">¿Para qué sirve la Sangría?</h3>
        <p class="text-gray-600 text-sm">
            La opción de "Sangría" te permite anidar visualmente los elementos de la descripción.
            <br><br>
            Cada nivel de sangría empuja el texto más hacia la derecha, creando una estructura jerárquica clara. Es útil para listar sub-pasos o notas debajo de un punto principal.
            <br><br>
            <strong>Ejemplo:</strong>
            <ul class="list-disc pl-5 mt-2 text-xs bg-gray-50 p-2 rounded-lg">
                <li>Punto Principal (Sin Sangría)</li>
                <li class="ml-4">Sub-punto (Sangría 1)</li>
                <li class="ml-8">Sub-sub-punto (Sangría 2)</li>
            </ul>
        </p>
        <div class="text-right mt-4">
            <button id="closeHelpModal" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">Entendido</button>
        </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

        function setupDynamicList(addButtonId, containerId, itemClass, removeButtonClass, htmlContent, initialUpdate = true) {
            document.getElementById(addButtonId).addEventListener('click', () => {
                const container = document.getElementById(containerId);
                const newItem = document.createElement('div');
                newItem.className = itemClass;
                newItem.innerHTML = htmlContent;
                container.appendChild(newItem);

                newItem.querySelector(removeButtonClass).addEventListener('click', function() {
                    newItem.remove();
                    if(initialUpdate) updateRemoveButtons(`#${containerId}`, `.${itemClass.split(' ')[0]}`, removeButtonClass);
                });

                if(initialUpdate) updateRemoveButtons(`#${containerId}`, `.${itemClass.split(' ')[0]}`, removeButtonClass);
            });
            if(initialUpdate) updateRemoveButtons(`#${containerId}`, `.${itemClass.split(' ')[0]}`, removeButtonClass);
        }

        function updateRemoveButtons(containerSelector, itemSelector, buttonSelector) {
            const container = document.querySelector(containerSelector);
            if (!container) return;
            const items = container.querySelectorAll(itemSelector);
            items.forEach((item) => {
                const removeBtn = item.querySelector(buttonSelector);
                if (removeBtn) {
                    removeBtn.style.display = items.length > 1 ? 'inline-flex' : 'none';
                }
            });
        }

        setupDynamicList('addMarcoTeorico', 'marcoTeoricoContainer', 'marco-teorico-item flex gap-2 mt-2', '.remove-btn', `
            <input type="text" class="marco-teorico-input flex-1 border rounded-xl p-3" placeholder="Ingrese texto del marco teórico...">
            <button type="button" class="remove-btn text-red-500 px-2 items-center justify-center">✕</button>
        `);
        setupDynamicList('addDefinicion', 'definicionesContainer', 'definicion-item flex gap-2 mt-2', '.remove-def', `
            <input type="text" class="def-termino border rounded-xl p-3 w-1/3" placeholder="Término">
            <input type="text" class="def-descripcion border rounded-xl p-3 flex-1" placeholder="Descripción">
            <button type="button" class="remove-def text-red-500 px-2 flex items-center justify-center">✕</button>
        `);
        setupDynamicList('addMaterial', 'materialesContainer', 'material-item flex gap-2 mt-2', '.remove-mat', `
            <input type="text" class="material-input flex-1 border rounded-xl p-3" placeholder="Ingrese material...">
            <button type="button" class="remove-mat text-red-500 px-2 flex items-center justify-center">✕</button>
        `);
        setupDynamicList('addRegistro', 'registrosContainer', 'registro-item flex gap-2 mt-2', '.remove-reg', `
            <input type="text" class="registro-input flex-1 border rounded-xl p-3" placeholder="Ingrese registro...">
            <button type="button" class="remove-reg text-red-500 px-2 flex items-center justify-center">✕</button>
        `);
        
        const cambiosTableBody = document.getElementById('cambiosTableBody');
        document.getElementById('addCambio').addEventListener('click', () => {
            const newRow = cambiosTableBody.insertRow();
            newRow.className = 'cambio-row';
            newRow.innerHTML = `
                <td class="border border-gray-300 p-2"><input type="text" class="cambio-version w-full border-0 p-1" placeholder="1.1"></td>
                <td class="border border-gray-300 p-2"><input type="date" class="cambio-fecha w-full border-0 p-1"></td>
                <td class="border border-gray-300 p-2"><input type="text" class="cambio-descripcion w-full border-0 p-1" placeholder="Descripción del cambio"></td>
                <td class="border border-gray-300 p-2 text-center"><button type="button" class="remove-cambio text-red-500">✕</button></td>
            `;
            updateRemoveButtons('#cambiosTableBody', '.cambio-row', '.remove-cambio');
        });

        cambiosTableBody.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('remove-cambio')) {
                e.target.closest('.cambio-row').remove();
                updateRemoveButtons('#cambiosTableBody', '.cambio-row', '.remove-cambio');
            }
        });
        updateRemoveButtons('#cambiosTableBody', '.cambio-row', '.remove-cambio');

        const responsabilidadesContainer = document.getElementById('responsabilidadesContainer');
        document.getElementById('addResponsabilidadPrincipal').addEventListener('click', () => {
            const principalId = `resp-${Date.now()}`;
            const newItem = document.createElement('div');
            newItem.className = 'responsabilidad-principal-item bg-gray-50 border rounded-xl p-3';
            newItem.innerHTML = `
                <div class="flex gap-2 items-center">
                    <span class="font-semibold text-gray-600">Principal:</span>
                    <input type="text" class="responsabilidad-principal-texto flex-1 border rounded-xl p-2" placeholder="Texto de la responsabilidad principal...">
                    <button type="button" class="add-subresponsabilidad bg-green-100 text-green-700 rounded px-3 py-1 text-xs">+ Sub</button>
                    <button type="button" class="remove-principal text-red-500 px-2">✕</button>
                </div>
                <div id="${principalId}" class="sub-responsabilidades-container pl-8 mt-2 space-y-2"></div>
            `;
            responsabilidadesContainer.appendChild(newItem);

            newItem.querySelector('.remove-principal').addEventListener('click', () => newItem.remove());

            newItem.querySelector('.add-subresponsabilidad').addEventListener('click', () => {
                const subContainer = newItem.querySelector('.sub-responsabilidades-container');
                const subItem = document.createElement('div');
                subItem.className = 'sub-responsabilidad-item flex gap-2 items-center';
                subItem.innerHTML = `
                    <span class="text-gray-500">Secundario:</span>
                    <input type="text" class="sub-responsabilidad-texto flex-1 border rounded-xl p-2" placeholder="Texto de la sub-responsabilidad...">
                    <button type="button" class="remove-sub text-red-500 px-2">✕</button>
                `;
                subContainer.appendChild(subItem);
                subItem.querySelector('.remove-sub').addEventListener('click', () => subItem.remove());
            });
        });

        // ====================================================================================
        // === INICIO: LÓGICA MEJORADA PARA "DESCRIPCIÓN DE LA ACTIVIDAD" CON SANGRÍA ===
        // ====================================================================================
        const actividadContainer = document.getElementById('actividadContainer');
        document.getElementById('addTitulo').addEventListener('click', () => {
            const newElement = document.createElement('div');
            newElement.className = 'actividad-item-container'; 

            newElement.innerHTML = `
                <div class="actividad-item bg-gray-50 border rounded-xl p-3 flex gap-2 items-center transition-all duration-300">
                    <select class="actividad-estilo border-gray-300 rounded-lg text-sm w-48">
                        <option value="titulo">Título (7.x)</option>
                        <option value="subtitulo">Sub-título (7.x.x)</option>
                        <option value="guion">Viñeta (-)</option>
                        <option value="check">Check (✓)</option>
                        <option value="normal" selected>Párrafo</option>
                    </select>
                    <select class="actividad-sangria border-gray-300 rounded-lg text-sm w-32">
                        <option value="pl-0" selected>Sin Sangría</option>
                        <option value="pl-6">Sangría 1</option>
                        <option value="pl-12">Sangría 2</option>
                        <option value="pl-16">Sangría 3</option>
                    </select>
                    <textarea class="actividad-texto flex-1 border rounded-xl p-2" rows="1" placeholder="Escriba el texto aquí..."></textarea>
                    <button type="button" class="remove-actividad text-red-500 px-2">✕</button>
                </div>
            `;
            actividadContainer.appendChild(newElement);

            const itemDiv = newElement.querySelector('.actividad-item');
            const sangriaSelect = newElement.querySelector('.actividad-sangria');

            sangriaSelect.addEventListener('change', (e) => {
                itemDiv.classList.remove('pl-0', 'pl-6', 'pl-12', 'pl-16');
                itemDiv.classList.add(e.target.value);
            });

            newElement.querySelector('.remove-actividad').addEventListener('click', () => newElement.remove());
        });

        document.getElementById('procedimientoForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            function formatYyyyMmDdToDdMmYyyy(dateString) {
                if (!dateString) return '';
                const [year, month, day] = dateString.split('-');
                return `${day}-${month}-${year}`;
            }

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            const responsabilidadesAplanadas = [];
            document.querySelectorAll('.responsabilidad-principal-item').forEach(item => {
                const principalTexto = item.querySelector('.responsabilidad-principal-texto').value;
                if (principalTexto) {
                    responsabilidadesAplanadas.push({ tipo: 'principal', texto: principalTexto });
                }
                item.querySelectorAll('.sub-responsabilidad-item').forEach(subItem => {
                    const subTexto = subItem.querySelector('.sub-responsabilidad-texto').value;
                    if (subTexto) {
                        responsabilidadesAplanadas.push({ tipo: 'secundario', texto: subTexto });
                    }
                });
            });

            // ====================================================================================
            // === INICIO: LÓGICA DE PROCESAMIENTO DE ACTIVIDAD CON SANGRÍA COLGANTE (HANGING INDENT) ===
            // ====================================================================================
            const actividadesAplanadas = [];
            let tituloCounter = 1;
            let subTituloCounter = 1;
            let lastTituloNum = '';

            document.querySelectorAll('.actividad-item-container').forEach(item => {
                const estilo = item.querySelector('.actividad-estilo').value;
                const sangriaValue = item.querySelector('.actividad-sangria').value;
                const texto = item.querySelector('.actividad-texto').value;
                
                if (!texto) return;

                // --- 1. Calcular la sangría ESTRUCTURAL (el empuje de todo el bloque) ---
                let sangriaEstructural = '';
                if (sangriaValue === 'pl-6') { 
                    sangriaEstructural = '  '; // 2 espacios
                } else if (sangriaValue === 'pl-12') { 
                    sangriaEstructural = '    '; // 4 espacios
                } else if (sangriaValue === 'pl-16') { 
                    sangriaEstructural = '      '; // 6 espacios
                }

                // --- 2. Determinar el PREFIJO DE ESTILO (el símbolo y su espaciado) ---
                let prefijoDeEstilo = '';
                switch (estilo) {
                    case 'titulo':
                        lastTituloNum = `7.${tituloCounter}`;
                        prefijoDeEstilo = `${lastTituloNum} `;
                        tituloCounter++;
                        subTituloCounter = 1; 
                        break;
                    case 'subtitulo':
                        if (lastTituloNum) {
                            prefijoDeEstilo = `${lastTituloNum}.${subTituloCounter} `;
                            subTituloCounter++;
                        } else {
                           prefijoDeEstilo = `- `; // Fallback si no hay título padre
                        }
                        break;
                    case 'guion':
                        prefijoDeEstilo = `- `;
                        break;
                    case 'check':
                        prefijoDeEstilo = `✓ `;
                        break;
                    case 'normal':
                    default:
                        prefijoDeEstilo = ''; // Párrafo normal no tiene prefijo
                        break;
                }
                
                // --- 3. Calcular la SANGRÍA PARA LÍNEAS SIGUIENTES (para alinear el texto) ---
                // Es la sangría estructural + espacios vacíos del tamaño del prefijo de estilo
                const sangriaParaSaltoDeLinea = sangriaEstructural + ' '.repeat(prefijoDeEstilo.length);

                // --- 4. Aplicar la sangría a las líneas subsiguientes del texto ---
                const textoConSangriaColgante = texto.replace(/\n/g, '\n' + sangriaParaSaltoDeLinea);
                
                // --- 5. Construir el texto final ---
                const textoFinal = sangriaEstructural + prefijoDeEstilo + textoConSangriaColgante;
                
                actividadesAplanadas.push({ 
                    texto: textoFinal
                });
            });
            // ====================================================================================
            // === FIN: LÓGICA DE PROCESAMIENTO DE ACTIVIDAD ===
            // ====================================================================================

            const finalJson = {
                titulo1: data.titulo1 || '',
                titulo2: data.titulo2 || '',
                codigo: data.codigo,
                fecha_creacion: formatYyyyMmDdToDdMmYyyy(data.fecha_creacion),
                version: data.version,
                fecha_modificacion: formatYyyyMmDdToDdMmYyyy(data.fecha_modificacion),
                elaboro: data.elaboro,
                cargo_elaboro: data.cargo_elaboro,
                reviso: data.reviso,
                cargo_reviso: data.cargo_reviso,
                aprobo: data.aprobo,
                cargo_aprobo: data.cargo_aprobo,
                objetivo: data.objetivo,
                alcance: data.alcance,
                
                marco_teorico: Array.from(document.querySelectorAll('.marco-teorico-input')).map(i => ({ texto: i.value })).filter(o => o.texto),
                definiciones: Array.from(document.querySelectorAll('.definicion-item')).map(item => ({ termino: item.querySelector('.def-termino').value, descripcion: item.querySelector('.def-descripcion').value })).filter(o => o.termino && o.descripcion),
                materiales: Array.from(document.querySelectorAll('.material-input')).map(i => ({ texto: i.value })).filter(o => o.texto),
                registros: Array.from(document.querySelectorAll('.registro-input')).map(i => ({ texto: i.value })).filter(o => o.texto),
                
                responsabilidades_lista: responsabilidadesAplanadas,
                descripcion_actividad_lista: actividadesAplanadas,
                
                control_cambios: Array.from(document.querySelectorAll('.cambio-row')).map(row => ({
                    version: row.querySelector('.cambio-version').value,
                    fecha_modificacion: formatYyyyMmDdToDdMmYyyy(row.querySelector('.cambio-fecha').value), 
                    descripcion_cambio: row.querySelector('.cambio-descripcion').value
                })).filter(o => o.version && o.fecha_modificacion && o.descripcion_cambio)
            };

            console.log("JSON plano generado:", JSON.stringify(finalJson, null, 2));
            sendDataToN8n(finalJson);
        });

        function sendDataToN8n(data) {
            const submitBtn = document.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Enviando...';
            submitBtn.disabled = true;

            const webhookURL = 'https://agentes-liw-n8n.6tpykr.easypanel.host/webhook/aec6ee18-fca8-401d-98ac-22677f5237f2';

            fetch(webhookURL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error en la red: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                alert('¡Éxito! Los datos han sido enviados al sistema.');
                console.log('Respuesta del sistema:', result);
            })
            .catch(error => {
                console.error('Error al enviar al sistema:', error);
                alert(`Hubo un error al enviar los datos: ${error.message}`);
            })
            .finally(() => {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        }
        
        // --- Lógica para el modal de ayuda de sangría ---
        const sangriaHelpIcon = document.getElementById('sangriaHelpIcon');
        const sangriaHelpModal = document.getElementById('sangriaHelpModal');
        const modalContent = sangriaHelpModal.querySelector('div');
        const closeHelpModal = document.getElementById('closeHelpModal');

        sangriaHelpIcon.addEventListener('click', () => {
            sangriaHelpModal.classList.remove('hidden');
            setTimeout(() => { 
              sangriaHelpModal.classList.remove('opacity-0');
              modalContent.classList.remove('scale-95');
            }, 10);
        });

        const closeModal = () => {
            sangriaHelpModal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => { 
              sangriaHelpModal.classList.add('hidden');
            }, 300);
        };

        closeHelpModal.addEventListener('click', closeModal);

        sangriaHelpModal.addEventListener('click', (e) => {
            if (e.target === sangriaHelpModal) {
                closeModal();
            }
        });
    });
 </script>
</body>
</html>
